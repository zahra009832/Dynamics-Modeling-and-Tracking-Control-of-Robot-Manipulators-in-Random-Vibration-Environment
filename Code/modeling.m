clc
clear all
close all
%% initial values
m1=0.5;
m2=0.5;
m3=0.5;
l1=3;
l2=3;
l3=1.5;
lc1=1.5;
lc2=1.5;
lc3=1;
g=9.8;
c1=10;
c2=1;
ebsilon=0.5;


%%

n=3;
p1=0;
p2=0;
p3=0;
q1=0.55;
q2=1.15;
q3=-0.65;
p(:,1)=[p1;p2;p3];
q(:,1)=[q1;q2;q3];
h=0.01;
t=0:h:10;
[nn,mm]=size(t);
y=1/h;
u(:,1)=[0;10;0];
z1(:,1)=[0.0151;0.1503;-0.1503];
z2(:,1)=[-0.9459;4.3443;-1.7395];



%%
    r(1,1)=0.1;
    r(2,2)=0.1;
    r(1,2)=0;
    r(2,1)=0;
    T=[r(1,1) r(1,2);r(2,1) r(2,2)];
    normTT=sqrt((r(1,1)^2+r(1,2)^2+r(2,1)^2+r(2,2)^2));
    normT=(normTT)^4;
    

for i=2:length(t)
    
    M(1,1)=m1*lc1^2+m2*l1^2+m3*l1^2;
    M(2,2)=m2*lc2^2+m3*l2^2;
    M(3,3)=m3*lc3^2;
    M(1,2)=(m2*l1*lc2+m3*l1*l2)*cos(q(2,i-1)-q(1,i-1));
    M(2,1)=(m2*l1*lc2+m3*l1*l2)*cos(q(2,i-1)-q(1,i-1));
    M(1,3)=m3*l1*lc3*cos(q(3,i-1)-q(1,i-1));
    M(3,1)=m3*l1*lc3*cos(q(3,i-1)-q(1,i-1));
    M(2,3)=m3*l2*lc3*cos(q(3,i-1)-q(2,i-1));
    M(3,2)=m3*l2*lc3*cos(q(3,i-1)-q(2,i-1));
    M_q=[M(1,1) M(1,2) M(1,3);M(2,1) M(2,2) M(2,3);M(3,1) M(3,2) M(3,3)];
    
    
    q(:,i)=(h*(M_q^(-1)*p(:,i-1))+q(:,i-1));
    p_q=(m1*lc1+m2*l1+m3*l1)*g*sin(q(1,i-1))+(m2*lc2+m3*l2)*g*sin(q(2,i-1))+m3*lc3*g*sin(q(3,i-1));
    H(i-1)=(transpose(p(:,i-1))*((M_q))^(-1)*p(:,i-1)/2-p_q);

    
    H2(i-1)=(441*cos(q(2,i-1))/20 - p(2,i-1)*((8*p(3,i-1)*(3*sin(q(2,i-1)-q(3,i-1)) + 2*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) + (8*p(2,i-1)*(4*cos(q(1,i-1)-q(3,i-1))^2 - 9)*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) - 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (16*p(1,i-1)*(3*cos(q(1,i-1)-q(2,i-1)) - 2*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) - 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (8*p(3,i-1)*(3*cos(q(2,i-1)-q(3,i-1)) - 2*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) - 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) - p(1,i-1)*((64*p(1,i-1)*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) - (8*p(3,i-1)*(6*cos(q(1,i-1)-q(2,i-1))*sin(q(2,i-1)-q(3,i-1)) - 6*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) - (16*p(2,i-1)*(3*sin(q(1,i-1)-q(2,i-1)) + 2*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) + (8*p(1,i-1)*(4*cos(q(2,i-1)-q(3,i-1))^2 - 5)*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) - 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (16*p(2,i-1)*(3*cos(q(1,i-1)-q(2,i-1)) - 2*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) - 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (8*p(3,i-1)*(5*cos(q(1,i-1)-q(3,i-1)) - 6*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) - 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2)) - p(3,i-1)*((8*p(2,i-1)*(3*sin(q(2,i-1)-q(3,i-1)) + 2*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45) - (8*p(1,i-1)*(6*cos(q(1,i-1)-q(2,i-1))*sin(q(2,i-1)-q(3,i-1)) - 6*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) - (144*p(3,i-1)*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45) + (18*p(3,i-1)*(4*cos(q(1,i-1)-q(2,i-1))^2 - 5)*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) - 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2 + (8*p(2,i-1)*(3*cos(q(2,i-1)-q(3,i-1)) - 2*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) - 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2 + (8*p(1,i-1)*(5*cos(q(1,i-1)-q(3,i-1)) - 6*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) - 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2)));
    H1(i-1)=p(1,i-1)*((8*p(1,i-1)*(4*cos(q(2,i-1)-q(3,i-1))^2 - 5)*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) + 40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) - (8*p(3,i-1)*(5*sin(q(1,i-1)-q(3,i-1)) - 6*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) - (16*p(2,i-1)*(3*sin(q(1,i-1)-q(2,i-1)) - 2*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) + (16*p(2,i-1)*(3*cos(q(1,i-1)-q(2,i-1)) - 2*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) + 40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (8*p(3,i-1)*(5*cos(q(1,i-1)-q(3,i-1)) - 6*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) + 40*cos(q(1,i-1) - q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2)) - (147*cos(q(1,i-1)))/4 + p(2,i-1)*((8*p(3,i-1)*(2*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(3,i-1)) + 2*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45) - (16*p(1,i-1)*(3*sin(q(1,i-1)-q(2,i-1)) - 2*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) - (64*p(2,i-1)*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) + (8*p(2,i-1)*(4*cos(q(1,i-1)-q(3,i-1))^2 - 9)*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) + 40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (16*p(1,i-1)*(3*cos(q(1,i-1)-q(2,i-1)) - 2*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) + 40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (8*p(3,i-1)*(3*cos(q(2,i-1)-q(3,i-1)) - 2*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) + 40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + p(3,i-1)*((8*p(2,i-1)*(2*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(3,i-1)) + 2*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45) - (8*p(1,i-1)*(5*sin(q(1,i-1)-q(3,i-1)) - 6*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) - (144*p(3,i-1)*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45) + (18*p(3,i-1)*(4*cos(q(1,i-1)-q(2,i-1))^2 - 5)*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) + 40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2 + (8*p(2,i-1)*(3*cos(q(2,i-1)-q(3,i-1)) - 2*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) + 40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1) - q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2 + (8*p(1,i-1)*(5*cos(q(1,i-1)-q(3,i-1)) - 6*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1)))*(72*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(2,i-1)) + 40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2));
    H3(i-1)=(49*cos(q(3,i-1)))/10 - p(3,i-1)*((18*p(3,i-1)*(4*cos(q(1,i-1)-q(2,i-1))^2 - 5)*(40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) + 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2 - (8*p(1,i-1)*(5*sin(q(1,i-1)-q(3,i-1)) - 6*cos(q(1,i-1)-q(2,i-1))*sin(q(2,i-1)-q(3,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) - (8*p(2,i-1)*(3*sin(q(2,i-1)-q(3,i-1)) - 2*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(3,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45) + (8*p(2,i-1)*(3*cos(q(2,i-1)-q(3,i-1)) - 2*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1)))*(40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(2,i-1)) + 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2 + (8*p(1,i-1)*(5*cos(q(1,i-1)-q(3,i-1)) - 6*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1)))*(40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) + 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2)) - p(2,i-1)*((16*p(1,i-1)*(2*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 2*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) - (8*p(3,i-1)*(3*sin(q(2,i-1)-q(3,i-1)) - 2*cos(q(1,i-1)-q(2,i-1))*sin(q(1,i-1)-q(3,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45) - (64*p(2,i-1)*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) + (8*p(2,i-1)*(4*cos(q(1,i-1)-q(3,i-1))^2 - 9)*(40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) + 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (16*p(1,i-1)*(3*cos(q(1,i-1)-q(2,i-1)) - 2*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)))*(40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) + 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (8*p(3,i-1)*(3*cos(q(2,i-1)-q(3,i-1)) - 2*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1)))*(40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) + 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1) )*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) - p(1,i-1)*((16*p(2,i-1)*(2*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) + 2*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) - (8*p(3,i-1)*(5*sin(q(1,i-1)-q(3,i-1)) - 6*cos(q(1,i-1)-q(2,i-1))*sin(q(2,i-1)-q(3,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) - (64*p(1,i-1)*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)) + (8*p(1,i-1)*(4*cos(q(2,i-1)-q(3,i-1))^2 - 5)*(40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) + 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (16*p(2,i-1)*(3*cos(q(1,i-1)-q(2,i-1)) - 2*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)))*(40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) + 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(9*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2) + (8*p(3,i-1)*(5*cos(q(1,i-1)-q(3,i-1)) - 6*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1)))*(40*cos(q(1,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1)) + 72*cos(q(2,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*sin(q(2,i-1)-q(3,i-1)) - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(2,i-1)-q(3,i-1))*sin(q(1,i-1)-q(3,i-1))))/(3*(36*cos(q(1,i-1)-q(2,i-1))^2 + 20*cos(q(1,i-1)-q(3,i-1))^2 + 36*cos(q(2,i-1)-q(3,i-1))^2 - 48*cos(q(1,i-1)-q(2,i-1))*cos(q(1,i-1)-q(3,i-1))*cos(q(2,i-1)-q(3,i-1)) - 45)^2));
    Hdot=H1(i-1)+H2(i-1)+H3(i-1);


    G_q=[1 l1*cos(q(2,i-1)-q(1,i-1))/lc2 l1*cos(q(3,i-1)-q(1,i-1))/lc3; 0 1 l2*cos(q(3,i-1)-q(2,i-1))/lc3;0 0 1];
    
    
    A(1,1)=m1*lc1*sin(q(1,i-1))+m2*l1*cos(q(1,i-1))*sin(q(2,i-1)-q(1,i-1))*cos(q(2,i-1)-q(1,i-1))+m3*l1*cos(q(1,i-1))*cos(q(2,i-1)-...
    q(1,i-1)*sin(q(3,i-1)-q(2,i-1))*cos(q(3,i-1)-q(1,i-1)));
    A(1,2)=m1*lc1*cos(q(1,i-1))+m2*l1*sin(q(1,i-1))*sin(q(2,i-1)-q(1,i-1))*cos(q(2,i-1)-q(1,i-1))+m3*l1*sin(q(1,i-1))*cos(q(2,i-1)...
    -q(1,i-1))*sin(q(3,i-1)-q(2,i-1))*cos(q(3,i-1)-q(1,i-1));
    A(2,1)=m2*lc2*cos(q(1,i-1))*sin(q(2,i-1)-q(1,i-1))+m3*l2*cos(q(1,i-1))*cos(q(2,i-1)-q(1,i-1))*sin(q(3,i-1)-q(2,i-1))*cos(q(3,i-1)...
    -q(2,i-1));
    A(2,2)=m2*lc2*sin(q(1,i-1))*sin(q(2,i-1)-q(1,i-1))+m3*l2*sin(q(1,i-1))*cos(q(2,i-1)-q(1,i-1))*sin(q(3,i-1)-q(2,i-1))...
    *cos(q(3,i-1)-q(2,i-1));
    A(3,1)=m3*lc3*cos(q(1,i-1))*cos(q(2,i-1)-q(1,i-1))*sin(q(3,i-1)-q(2,i-1));
    A(3,2)=m3*lc3*sin(q(1,i-1))*cos(q(2,i-1)-q(1,i-1))*sin(q(3,i-1)-q(2,i-1));
    A_q=[A(1,1) A(1,2);A(2,1) A(2,2);A(3,1) A(3,2)];
    AA=sqrt(A(1,1)^2+A(1,2)^2+A(2,1)^2+A(2,2)^2+A(3,1)^2+A(3,2)^2);
    A=AA^(4);
    W=M_q^(-1);
    QQ=sqrt(W(1,1)^2+W(1,2)^2+W(1,3)^2+W(2,1)^2+W(2,2)^2+W(2,3)^2+W(3,1)^2+W(3,2)^2+W(3,3)^2);
    Q=(QQ)^4;
    
%     p(:,i)=(h*(-Hdot+G_q*u(:,i-1)+A_q*[rand; rand])+p(:,i-1));
    A1=-Hdot+G_q*u(:,i-1);
    B=A_q*T;
%     p(:,i ) = p(:,i-1 ) + (A * h) + (B * sqrt(h) * randn(1,y));
%     p(:,i ) = p(:,i-1 ) + (A1 * h) + (B * [sqrt(h) * randn(1,1);(sqrt(h) * randn(1,1))]);
    
    
    randn('state',100)           % set the state of randn

dW = zeros(1,mm);             % preallocate arrays ...
W = zeros(1,mm);              % for efficiency

dW(1) = sqrt(h)*randn;      % first approximation outside the loop ...
W(1) = dW(1);                % since W(0) = 0 is not allowed

   dW(i) = sqrt(h)*randn;   % general increment
   W(i) = W(i-1) + dW(i); 

    p(:,i ) = p(:,i-1 ) +(A1 * h) + (B * [(W(i) - W(i-1));(W(i) - W(i-1))]);

    
    
    
    
    
    
    qr1(i-1,:)=((0.5+sin(i*pi/180)));
    qrd1(i-1,:)=transpose(cos(i*pi/180));
    qrdd1(i-1,:)=transpose(-sin(i*pi/180));

    qr2(i-1,:)=(0.5+0.5*cos(i*pi/180));
    qrd2(i-1,:)=(-0.5*sin(i*pi/180));
    qrdd2(i-1,:)=(-0.5*cos(i*pi/180));

    qr3(i-1,:)=(-0.5*cos(i*pi/180));
    qrd3(i-1,:)=(0.5*sin(i*pi/180));
    qrdd3(i-1,:)=(0.5*cos(i*pi/180));

    qr=transpose([qr1,qr2,qr3]);
    qrd=transpose([qrd1,qrd2,qrd3]);
    qrdd=transpose([qrdd1,qrdd2,qrdd3]);
    qd(1,i-1)=(q(1,i)-q(1,i-1))/h;
    qd(2,i-1)=((q(2,i)-q(2,i-1)))/h;
    qd(3,i-1)=((q(3,i)-q(3,i-1)))/h;
    qd(:,i-1)=[qd(1,i-1);qd(2,i-1);qd(3,i-1)];
    M_qdot(1,1)=0;
    M_qdot(2,2)=0;
    M_qdot(3,3)=0;
    M_qdot(1,2)=-(m1*lc1+m2*l1+m3*l1)*l2*(qd(1,i-1)-qd(2,i-1))*sin(q(1,i-1)-q(2,i-1));
    M_qdot(1,3)=-(m1*lc1+m2*l1+m3*l1)*l3*(qd(1,i-1)-qd(3,i-1))*sin(q(1,i-1)-q(3,i-1));
    M_qdot(2,1)=-(m2*lc2+m3*l2)*l1*(qd(2,i-1)-qd(1,i-1))*sin(q(2,i-1)-q(1,i-1));
    M_qdot(2,3)=-(m2*lc2+m3*l2)*l3*(qd(2,i-1)-qd(3,i-1))*sin(q(2,i-1)-q(3,i-1));
    M_qdot(3,1)=-(m3*lc3)*l1*(qd(3,i-1)-qd(1,i-1))*sin(q(3,i-1)-q(1,i-1));
    M_qdot(3,2)=-(m3*lc3)*l2*(qd(3,i-1)-qd(2,i-1))*sin(q(3,i-1)-q(2,i-1));
    M_qdot=[M_qdot(1,1) M_qdot(1,2) M_qdot(1,3);M_qdot(2,1) M_qdot(2,2) M_qdot(2,3);M_qdot(3,1) M_qdot(3,2) M_qdot(3,3)];
    phi(1)=1;
    phi(2)=(sin(q(2,i-1)-q(1,i-1)))^2+1;
    phi(3)=(cos(q(2,i-1)-q(1,i-1)))^2*(sin(q(3,i-1)-q(2,i-1)))^2+(cos(q(2,i-1)-q(1,i-1)))^2;
    f1=3*(2*m1^2*lc1^2*phi(1)+(2*3*m2^2*l1^2*(phi(2)*(cos(q(2,i-1)-q(1,i-1)))^2))...
    +(2*4*m3^2*l1^2*(phi(3)*(cos(q(3,i-1)-q(1,i-1)))^2+(cos(qr(2,i-1)-qr(1,i-1)))^2*(sin(qr(3,i-1)-qr(2,i-1)))^2)));
    f2=2*(2*2*m2^2*lc2^2*phi(2)+(2*3*m2^2*l1^2*(phi(2)*(cos(q(2,i-1)-q(2,i-1)))^2))...
    +(2*4*m3^2*l1^2*(phi(3)*(cos(q(3,i-1)-q(2,i-1)))^2+(cos(qr(2,i-1)-qr(1,i-1)))^2*(sin(qr(3,i-1)-qr(2,i-1)))^2)));
    f3=1*(2*3*m3^2*lc3^2*phi(3)+(2*3*m2^2*l1^2*(phi(2)*(cos(q(2,i-1)-q(3,i-1)))^2))...
    +(2*4*m3^2*l1^2*(phi(3)*(cos(q(3,i-1)-q(3,i-1)))^2+(cos(qr(2,i-1)-qr(1,i-1)))^2*(sin(qr(3,i-1)-qr(2,i-1)))^2)));
    f=f1+f2+f3;
    F=f^2;
    p_qdot=(m1*lc1+(m2*l1+m3*l1))*g*cos(q(1,i-1))+(m2*lc2+m3*l2)*g*cos(q(2,i-1))+m3*lc3*g*cos(q(3,i-1));
    alfa=-c1*M_q*z1(:,i-1);
     

z1(:,i)=(-c1*z1(:,i-1)+inv(M_q)*z2(:,i-1))*h+z1(:,i-1);
   
    u(:,i)=inv(G_q)*(-c2/2*z2(:,i-1)-27/(4*c1^3)*Q*z2(:,i-1)+Hdot+M_qdot*(-c1*z1(:,i-1)+qrd(:,i-1))-c1....
    *p(:,i-1)+M_q*(c1*qrd(:,i-1)+qrdd(:,i-1))-(9/c1*F+9/ebsilon*A)*normT*z2(:,i-1));
    

z2(:,i)=-(c2/2+27/(4*c1^3)*Q+(9/c1*F+9/ebsilon*A)*normT)*z2(:,i-1)*h+(B * [(W(i) - W(i-1));(W(i) - W(i-1))]);



end
u1=u(1,:);
u2=u(2,:);
u3=u(3,:);

figure(1)
plot(t,u1,'k')
hold on
plot(t,u2,'--b')
hold on
plot(t,u3,'-.r')
xlabel('Time(sec)');
ylabel('Control input (N.m)');
legend('u_1','u_2','u_3')


z11=z1(1,:);
z12=z1(2,:);
z13=z1(3,:);

figure(2)
hold on
plot(t,z11,'k')
plot(t,z12,'--b')
plot(t,z13,'-.r')
xlabel('Time(sec)');
ylabel('z_1_1 and z_1_2 and z_1_3');
legend('z_1_1=q_1-q_r_1','z_1_2=q_2-q_r_2','z_1_3=q_3-q_r_3')




figure(3)
hold on
plot(t,z2(1,:),'k')
plot(t,z2(2,:),'--b')
plot(t,z2(3,:),'-.r')
xlabel('Time(sec)');
ylabel('z_1_1 and z_1_2 and z_1_3');
legend('z_1_1=q_1-q_r_1','z_1_2=q_2-q_r_2','z_1_3=q_3-q_r_3')
